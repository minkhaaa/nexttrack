{# --- ERROR BOX (always render first if present) --- #}
{% if form_errors %}
  <div class="rounded-lg border border-red-300 bg-red-50 p-3 text-sm text-red-700 mb-3">
    {% for field, errors in form_errors.items %}
      {% for err in errors %}
        <p>{{ err }}</p>
      {% endfor %}
    {% endfor %}
  </div>
{% endif %}
{% if meta %}
  <div class="mb-3 flex flex-wrap items-center gap-2 text-sm">
    <span class="px-2 py-1 rounded-full bg-gray-200 text-gray-700">Seed: {{ meta.seed_artist }} / {{ meta.seed_track }}</span>
    {% if meta.seed_tags %}
      <span class="px-2 py-1 rounded-full bg-gray-200 text-gray-700">Tags: {{ meta.seed_tags|join:", " }}</span>
    {% endif %}
    <span class="px-2 py-1 rounded-full bg-gray-200 text-gray-700">Fetched: {{ meta.counts.fetched }}</span>
    <span class="px-2 py-1 rounded-full bg-gray-200 text-gray-700">Returned: {{ meta.counts.returned }}</span>

    <!-- Sort selector -->
    <label class="ml-auto flex items-center gap-2">
      <span class="text-gray-600">Sort</span>
      <select id="client-sort" class="border rounded px-2 py-1">
        <option value="hybrid" selected>Hybrid (default)</option>
        <option value="recent">Most Recent</option>
        <option value="popular">Most Popular</option>
        <option value="duration">Track Duration</option>
      </select>
    </label>
  </div>
{% endif %}

<div class="space-y-4">
<div id="results-list" class="space-y-4">
{% for t in tracks %}
  <div class="flex items-start gap-4 rounded-lg border border-gray-200 bg-white p-4"
       data-order="{{ forloop.counter0 }}"
       data-year="{% if t.spotify.album_release_date and t.spotify.album_release_date|slice:':4'|add:'0' %}{{ t.spotify.album_release_date|slice:':4' }}{% endif %}"
       data-pop="{{ t.spotify.popularity|default_if_none:-1 }}"
       data-dur="{{ t.spotify.duration_ms|default_if_none:-1 }}">
    {% if t.spotify.image_url %}
      <img src="{{ t.spotify.image_url }}" alt="cover" class="w-16 h-16 rounded shadow" />
    {% else %}
      <div class="w-16 h-16 rounded bg-gray-100 flex items-center justify-center text-[10px] text-gray-400">No Art</div>
    {% endif %}

    <div class="flex-1 min-w-0">
      <div class="flex flex-col">
        <div class="text-base font-semibold text-gray-900 truncate">
          {% if t.url %}
            <a href="{{ t.url }}" target="_blank" rel="noopener" class="hover:underline">
              {{ t.track_name }}
            </a>
          {% else %}
            {{ t.track_name }}
          {% endif %}
        </div>
        <div class="text-sm text-gray-600 truncate">{{ t.artist_name }}</div>
      </div>

      <div class="mt-1 text-xs text-gray-600">
        {{ t.reason }}
      </div>

      <div class="mt-1 text-xs text-gray-500 flex flex-wrap gap-x-4 gap-y-1">
        {% if t.spotify.album_name %}
          <span>Album: <span class="font-medium">{{ t.spotify.album_name }}</span></span>
        {% endif %}
        {% if t.release_str %}
          <span>Release: <span class="font-medium">{{ t.release_str }}</span></span>
        {% endif %}
        {% if t.duration_str %}
          <span>‚è± <span class="font-medium">{{ t.duration_str }}</span></span>
        {% endif %}
        {% if t.spotify.popularity %}
          <span>üî• Popularity: <span class="font-medium">{{ t.spotify.popularity }}</span>/100</span>
        {% endif %}
      </div>

      {% if t.spotify.url %}
        <div class="text-xs text-blue-600 mt-1">
          <a href="{{ t.spotify.url }}" target="_blank" class="underline">Open in Spotify</a>
        </div>
      {% endif %}
    </div>
  </div>
{% empty %}
  <div class="text-gray-600">No results. Try a different seed.</div>
{% endfor %}
</div>

<script>
(function(){
  const select = document.getElementById('client-sort');
  const list = document.getElementById('results-list');
  if(!select || !list) return;
  function toNumber(v){ const n = parseInt(v, 10); return isNaN(n) ? -1 : n; }
  function sortNow(){
    const mode = select.value;
    const items = Array.from(list.children);
    const keyer = {
      recent: el => [toNumber(el.dataset.year), -toNumber(el.dataset.order)],
      popular: el => [toNumber(el.dataset.pop), -toNumber(el.dataset.order)],
      duration: el => [toNumber(el.dataset.dur), -toNumber(el.dataset.order)],
      hybrid: el => [0, -toNumber(el.dataset.order)],
    }[mode] || (el => [0, -toNumber(el.dataset.order)]);
    items.sort((a,b)=>{
      const ka = keyer(a); const kb = keyer(b);
      // compare tuples desc
      for(let i=0;i<ka.length;i++){ if(kb[i]!==ka[i]) return kb[i]-ka[i]; }
      return 0;
    });
    items.forEach(el=>list.appendChild(el));
  }
  select.addEventListener('change', sortNow);
})();
</script>
